### ะััะธะฒะธัะพะฒะฐะฝะธะต ะดะธะฐะปะพะณะพะฒ

* ะฅัะฐะฝะธะผ ัะฐัั ะฒ SQLite โค DIALOG_TTL_DAYS (ะดะตั. 90).
* ะะพััั ะฐััะธะฒะฝัะน ัะบัะธะฟั ะฒัะณััะถะฐะตั JSON ะฒ MinIO `ib-assistant-archive/YYYY-MM-DD/*.json` ะธ ัะดะฐะปัะตั ะทะฐะฟะธัะธ ะธะท ะะ.
* ะะพัะปะต ะฐััะธะฒะธัะพะฒะฐะฝะธั ะบะพะปะปะตะบัะธั `dialogs` ะฟะตัะตัะพะทะดะฐัััั ะธ ะฝะฐะฟะพะปะฝัะตััั ะฐะบััะฐะปัะฝัะผะธ ัะพัะบะฐะผะธ.
* ะะตัะตะผะตะฝะฝัะต:
    - DIALOG_TTL_DAYS      (days, default 90)
    - ARCHIVE_BUCKET       (s3-bucket, default ib-assistant-archive)
### ะะฝััััะผะตะฝั `web_search`
* ะัะธะฝััะพะฝะฝัะน ะฒัะทะพะฒ OpenAI Browser-tool.
* ะขะฐะนะผะฐัั ะทะฐะดะฐัััั `WEB_SEARCH_TIMEOUT_SEC` (ะฟะพ ัะผะพะปัะฐะฝะธั 20 ั).
* ะัะธ ััะฐะฑะฐััะฒะฐะฝะธะธ ัะฐะนะผะฐััะฐ Search-ะฐะณะตะฝั ะฒะพะทะฒัะฐัะฐะตั ัััะพะบั **TIMEOUT**,
  Critic ัะฝะธะถะฐะตั ัะฒะตัะตะฝะฝะพััั โ Expert-GC ะฟะตัะตัะพะดะธั ะบ fallback-ัะธะบะปั.

### Live-ััะฐัััั

* ะะฐะถะดัะน ัะทะตะป ะฟัะฑะปะธะบัะตั progress ะฒ Redis `status_bus`.
* Gateway ััะฐะฝัะปะธััะตั ัะพะฑััะธั ะฒ WebSocket/gRPC.
* ะคัะพะฝั ะฟะพะบะฐะทัะฒะฐะตั ัััะพะบั ยซะััะธััะตะฝั ะธัะตัโฆยป, ยซะจะฐะณ 2/4ยป ะธ ะดั.
* ะะฐะฝะพะฝะธัะตัะบะธะต stage-ะผะตัะบะธ: thinking | searching | web-search | step N/M | generating | done | timeout
# InfoSec Assistant (multi-agent + RAG)

* FastAPI backend, React frontend.
* ะฃะฟัะพัะตะฝะฝะฐั ะฐััะธัะตะบัััะฐ: Dialog-Manager โ Planner (gpt-4.1) โ ExpertGC (gpt-4.1).
* Redis โ ัะปะพัั, SQLite โ ะฟะพะปะฝัะน ะปะพะณ, Qdrant โ RAG, MinIO โ ัะฐะนะปั.

## ะะฑะปะฐััั ะทะฝะฐะฝะธะน

**ะััะธััะตะฝั ะพะฑััะตะฝ ะพัะฒะตัะฐัั ัะพะปัะบะพ ะฝะฐ ะฒะพะฟัะพัั ะฟะพ ะธะฝัะพัะผะฐัะธะพะฝะฝะพะน ะฑะตะทะพะฟะฐัะฝะพััะธ โ  
DLP, SIEM, SOC, ััะฐะฝะดะฐััั, ะฝะพัะผะฐัะธะฒั ะธ ััะทะฒะธะผะพััะธ.**  
ะัะปะธ ัะฟัะพัะธัั ะพ ััะผ-ัะพ ะฒะฝะต ััะพะน ะพะฑะปะฐััะธ, ะพะฝ ัะตััะฝะพ ัะบะฐะถะตั, ััะพ ะดะฐะฝะฝัั ะฝะตั.

## ะะฑัะทะฐัะตะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### ๐ ะะฑัะทะฐัะตะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต
```bash
OPENAI_API_KEY=sk-***        # ะฑะตะท ะฝะตะณะพ ะฐััะธััะตะฝั ะฒะตัะฝัั ะพัะธะฑะบั
```

### ๐ ะะตะบะพะผะตะฝะดัะตะผัะต:
- `REDIS_URL` - URL ะดะปั ะฟะพะดะบะปััะตะฝะธั ะบ Redis (ะฟะพ ัะผะพะปัะฐะฝะธั: redis://localhost:6379)
- `QDRANT_URL` - URL ะดะปั ะฟะพะดะบะปััะตะฝะธั ะบ Qdrant (ะฟะพ ัะผะพะปัะฐะฝะธั: http://localhost:6333)

ะกะพะทะดะฐะนัะต ัะฐะนะป `.env` ะฒ ะบะพัะฝะต ะฟัะพะตะบัะฐ:
```bash
OPENAI_API_KEY=sk-your-actual-openai-key-here
```

**โ๏ธ ะะฑัะทะฐัะตะปัะฝัะต ัะฐะณะธ ะดะปั ะทะฐะฟััะบะฐ:**

1. **ะกะพะทะดะฐะนัะต ัะฐะนะป `.env`** ะฒ ะบะพัะฝะต ะฟัะพะตะบัะฐ ั ะฒะฐัะธะผ OpenAI API ะบะปััะพะผ
2. **ะะปั ัะตััะธัะพะฒะฐะฝะธั ะฑะตะท API ะบะปััะฐ** ะธัะฟะพะปัะทัะนัะต `OPENAI_API_KEY=stub`
3. **ะะปั ัะฐะทัะฐะฑะพัะบะธ** ัะฑะตะดะธัะตัั, ััะพ ะฒัะต ัะตัะฒะธัั ะทะฐะฟััะตะฝั: Redis, Qdrant, MinIO
4. **ะัะธ ะพัะธะฑะบะฐั WebSocket** ะฟัะพะฒะตัััะต ะปะพะณะธ: `docker-compose logs backend`

## Quick start
```bash
docker-compose up --build
```

### ะะตัะฒะฐั ะธะฝะดะตะบัะฐัะธั

```bash
docker compose exec backend \
  python scripts/index_files.py --reindex
```

### ะะฝะดะตะบัะฐัะธั / ะฟะตัะตะธะฝะดะตะบัะฐัะธั ะดะพะบัะผะตะฝัะพะฒ

```bash
# ะะฐะณััะทะธะปะธ PDF ะฒัััะฝัั ะฒ MinIO ะบะพะฝัะพะปั โ ะทะฐะฟััะบะฐะตะผ reindex
docker compose exec backend python scripts/index_files.py --reindex

# ะะปะธ ะปะพะบะฐะปัะฝัะต ัะฐะนะปั
docker compose exec backend \
   python scripts/index_files.py --paths ib-docs/questionnaires/*.pdf

# ะะฐััะพะผะฝัะน bucket ะธ prefix
docker compose exec backend \
   python scripts/index_files.py --paths /path/to/files/*.pdf custom-bucket custom-prefix/

# ะัะพะฒะตัะธัั ัะพะดะตัะถะธะผะพะต MinIO
docker compose exec backend python -c "
from minio import Minio
mc = Minio('minio:9000', access_key='minioadmin', secret_key='minioadmin', secure=False)
for obj in mc.list_objects('ib-docs', recursive=True):
    print(f'{obj.object_name} ({obj.size} bytes)')
"
```

## ะััะธัะตะบัััะฐ

User โโ
      โ  WebSocket / gRPC
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ Gateway (FastAPI + grpclib) โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ rate-limit โข /metrics (Prom) โข status_bus โ WS                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                      โผ
โโโโโโโโโโโโโโโโโโโโโโ  DIALOG-MANAGER GROUP  โโโโโโโโโโโโโโโโโโโโโโ
โ DM-Router  (o3-mini)   โ classify: file | kb_search | request   โ
โ DM-Critic  (4.1-mini)  โ OK / ask-again                        โ
โ Slots โ Redis, follow-up loop while intent=="unknown"          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโงโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                      โ
                                      โผ
โโโโโโโโโโโโโโโโโโโโ  KB-SEARCH AGENT  โโโโโโโโโโโโโโโโโโโโ
โ 1) Qdrant `dialogs`  โ reuse if simโฅ0.95                โ
โ 2) Qdrant `docs`     โ rag_hits + similar_dialogs       โ
โ status: searching / web-search                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                      โ (context)
                                      โผ
โโโโโโโโโโโโโโโโโ Planner (gpt-4.1) โโโโโโโโโโโโโโโโโโ
โ build_plan(), need_clarify?, need_escalate?        โ
โ draft+Critic โ UI  |  plan[] + context โ Expert-GC โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                      โ
                                      โผ
โโโโโโโโโโโโโโโ  EXPERT GROUP CHAT (AutoGen)  โโโโโโโโโโโโโโโ
โ โข **DomainExpert** (gpt-4.1)   โ Infowatch-Expert / โฆ    โ
โ โข Search-Tool (o3-mini)        โ local + web_search      โ
โ โข Critic-Expert (4.1-mini)     โ OK / ADD_SEARCH         โ
โ โข **EvidenceAggregator** (4.1-mini) โ ัะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ โ
โ status: step i/N, generating;  timeout 5 min             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                      โ
                         Refine-Paraphraser (o3-mini)
                                      โ
                                      โผ
                                UI  (React)
                                   โข Message bubbles (MD)
                                   โข Live status & progress
                                   โข Copy-button, citation pop-up
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โโโโโ DATA & INFRA LAYER โโโโโ
 Redis โ slots, rate-limit, status_bus, web_search cache (TTL 24h)  
 SQLite โ `dialog_log` (FULL chat โค90 ะด); TTL-cron โ MinIO archive  
 Qdrant โ `docs` (RAG) โข `dialogs` (re-use)        (dynamic-k)  
 MinIO  โ PDF / ัะตะบ-ะปะธััั (File-Search)  
 Prometheus + Alertmanager โ ib_* metrics, latency & timeout alerts  
 Grafana/Loki/Jaeger โ dashboards, traces (โstep i/Nโ, local_search)  
 k6 load-test (nightly CI)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โโโโโ ะะะะะะ โโโโโ
o3-mini   โ DM-Router, embeddings, Search-Tool, Refiner, browser_search  
4.1-mini โ DM-Critic, Critic-Expert, EvidenceAggregator  
gpt-4.1  โ Planner, DomainExpert(s)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โโโโโ ะะะขะะ ะะะะะะกะ โโโโโ
User โบ DM-Router/DM-Critic โบ KB-Search (reuse?) โบ Planner  
โโโโโ file-shortcut โ File-Search โ URL  
โโโโโโโโโโโโโโ need_escalate โ Expert-GC (multi-round) โ Refine โบ UI

*ะัะต ััะฐะดะธะธ ะฟัะฑะปะธะบััั status-event; ัะฐะนะผะฐััั (web 20 s / GC 300 s) ะพััะตะบะฐัั ะดะพะปะณะธะต ะพะฟะตัะฐัะธะธ, ะพัะฟัะฐะฒะปัั ัะธััะตะผะฝะพะต โ๏ธ-ัะพะพะฑัะตะฝะธะต.*

### ะะพะฝะธัะพัะธะฝะณ ะธ ะดะฐัะฑะพัะดั

ะกะธััะตะผะฐ ะฒะบะปััะฐะตั ะฒ ัะตะฑั ะฟะพะปะฝะพัะตะฝะฝัะน ััะตะบ ะผะพะฝะธัะพัะธะฝะณะฐ ะฝะฐ ะฑะฐะทะต Prometheus ะธ Grafana.

- **Prometheus**: ะกะพะฑะธัะฐะตั ะผะตััะธะบะธ ั ะฑัะบะตะฝะดะฐ (`/metrics`), ะฒะบะปััะฐั ััะตััะธะบะธ ะทะฐะฟัะพัะพะฒ (`ib_req_total`), ะทะฐะดะตัะถะบะธ (`ib_stage_latency_sec`), ัะฐะนะผะฐััั (`ib_timeout_total`) ะธ ะดััะณะธะต. ะขะฐะบะถะต ะฝะฐัััะพะตะฝั ะฟัะฐะฒะธะปะฐ ะดะปั ะฐะปะตััะพะฒ (`alert.rules.yml`).
- **Grafana**: ะัะตะดะพััะฐะฒะปัะตั ะณะพัะพะฒัะน ะดะฐัะฑะพัะด "IB-Assistant Overview" ะดะปั ะฒะธะทัะฐะปะธะทะฐัะธะธ ะบะปััะตะฒัั ะผะตััะธะบ.

**ะะฐะบ ะฟะพะปััะธัั ะดะพัััะฟ ะบ ะดะฐัะฑะพัะดั:**
1. ะะฐะฟัััะธัะต ะฒัะต ัะตัะฒะธัั: `docker-compose up -d`.
2. ะัะบัะพะนัะต Grafana ะฒ ะฑัะฐัะทะตัะต: [http://localhost:3000](http://localhost:3000).
3. ะะพะนะดะธัะต ั ััะตัะฝัะผะธ ะดะฐะฝะฝัะผะธ ะฟะพ ัะผะพะปัะฐะฝะธั: `admin` / `admin`.
4. ะะตัะตะนะดะธัะต ะฒ ัะฐะทะดะตะป `Dashboards`. ะะฐัะฑะพัะด "IB-Assistant Overview" ะดะพะปะถะตะฝ ะฑััั ัะถะต ะดะพัััะฟะตะฝ, ัะฐะบ ะบะฐะบ ะพะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะธะผะฟะพััะธััะตััั ะฟัะธ ััะฐััะต ะบะพะฝัะตะนะฝะตัะฐ Grafana.

### ะะฐะผััั

ะกะธััะตะผะฐ ะธัะฟะพะปัะทัะตั ะฝะตัะบะพะปัะบะพ ััะพะฒะฝะตะน ะฟะฐะผััะธ ะดะปั ัััะตะบัะธะฒะฝะพะน ัะฐะฑะพัั:

1.  **ะัะฐัะบะพััะพัะฝะฐั ะฟะฐะผััั (ัะปะพัั)**:
    *   **ะขะตัะฝะพะปะพะณะธั**: Redis.
    *   **ะะฐะทะฝะฐัะตะฝะธะต**: ะฅัะฐะฝะตะฝะธะต ะบะปััะตะฒัั ัััะฝะพััะตะน (ัะฐะบะธั ะบะฐะบ `product`, `task`, `file_key`) ะฒ ัะฐะผะบะฐั ะพะดะฝะพะน ัะตััะธะธ. ะญัะพ ะฟะพะทะฒะพะปัะตั ะฐะณะตะฝัะฐะผ ะฑััััะพ ะฟะพะปััะฐัั ะดะพัััะฟ ะบ ะบะพะฝัะตะบััั ัะตะบััะตะณะพ ะดะธะฐะปะพะณะฐ.

2.  **ะะพะปะณะพััะพัะฝะฐั ะฟะฐะผััั (ะปะพะณะธ ะดะธะฐะปะพะณะพะฒ)**:
    *   **ะขะตัะฝะพะปะพะณะธั**: SQLite, ัะฐะฑะปะธัะฐ `dialog_log`.
    *   **ะะฐะทะฝะฐัะตะฝะธะต**: ะะพัะปะต ะบะฐะถะดะพะณะพ ะพัะฒะตัะฐ ะฐััะธััะตะฝัะฐ ะฟะพะปะฝะฐั ะฒะตัะบะฐ ะดะธะฐะปะพะณะฐ (ะฒะพะฟัะพั-ะพัะฒะตั) ัะพััะฐะฝัะตััั ะฒ ะฑะฐะทั ะดะฐะฝะฝัั ะฒ ัะพัะผะฐัะต JSON. ะญัะพ ะพะฑะตัะฟะตัะธะฒะฐะตั ะฟะพะปะฝัั ะธััะพัะธั ะฟะตัะตะฟะธัะบะธ ะดะปั ะฐะฝะฐะปะธะทะฐ ะธ ะพัะปะฐะดะบะธ.

3.  **ะะฐะทะฐ ะทะฝะฐะฝะธะน (ะฒะตะบัะพัั)**:
    *   **ะขะตัะฝะพะปะพะณะธั**: Qdrant, ะบะพะปะปะตะบัะธะธ `docs` ะธ `dialogs`.
    *   **ะะฐะทะฝะฐัะตะฝะธะต**:
        *   **`docs`**: ะฅัะฐะฝะธั ะฒะตะบัะพัั ะธะท ะฟัะพะธะฝะดะตะบัะธัะพะฒะฐะฝะฝัั ะดะพะบัะผะตะฝัะพะฒ (PDF, DOCX ะธ ั.ะด.).
        *   **`dialogs`**: ะะพัะปะต ะทะฐะฒะตััะตะฝะธั ะดะธะฐะปะพะณะฐ ะฟะฐัะฐ (ะฒะพะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั, ัะธะฝะฐะปัะฝัะน ะพัะฒะตั ะฐััะธััะตะฝัะฐ) ะฒะตะบัะพัะธะทัะตััั ะธ ะดะพะฑะฐะฒะปัะตััั ะฒ ััั ะบะพะปะปะตะบัะธั.
    *   **ะัะพัะตัั ะฟะพะธัะบะฐ**: `KB-Search-Agent` ะฒัะฟะพะปะฝัะตั ะดะฒััััะฐะฟะฝัะน ะฟะพะธัะบ ั ัะผะฝัะผ ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ:
        *   **ะญัะฐะฟ 1**: ะะพะธัะบ ะฒ `dialogs` ั ะฟัะพะฒะตัะบะพะน similarity score (โฅ0.95 = reuse, 0.60-0.95 = ะบะพะฝัะตะบัั).
        *   **ะญัะฐะฟ 2**: ะะพะธัะบ ะฒ `docs` ะดะปั ะฟะพะปััะตะฝะธั RAG-ะบะพะฝัะตะบััะฐ.
        *   **ะะตะทัะปััะฐั**: ะะธะฑะพ ะณะพัะพะฒัะน ะพัะฒะตั ะธะท ะฟะฐะผััะธ, ะปะธะฑะพ ะพะฑะพะณะฐัะตะฝะฝัะน ะบะพะฝัะตะบัั ะดะปั Planner'ะฐ.

### ะะพะฒะฐั ัะฟัะพัะตะฝะฝะฐั ะฐััะธัะตะบัััะฐ

**Dialog Manager** ะทะฐะผะตะฝะธะป ัะปะพะถะฝัะน Router ะธ ัะตะฟะตัั ะพะฑัะฐะฑะฐััะฒะฐะตั ะฒัะพะดััะธะต ัะพะพะฑัะตะฝะธั ะฟะพ ะฟัะพััะพะน ะปะพะณะธะบะต:

1. **ะะปะฐััะธัะธะบะฐัะธั small_talk / file / request** ะฒัะฟะพะปะฝัะตััั ะผะพะดะตะปัั **o3-mini** ะฟะพ ะบะพัะพัะบะพะผั ะฟัะพะผะฟัั, ะฑะตะท ััะฐัะธัะตัะบะธั ัะปะพะฒะฐัะตะน.
2. **DM-Critic (4.1-mini)** ะฟะพะฒัะพัะฝะพ ะฟัะพะฒะตััะตั ัะตัะตะฝะธะต (score โฅ 0.5).
3. **File shortcuts** โ ะตัะปะธ ะฒ slots ะตััั `file_key`, ััะฐะทั ะฒะพะทะฒัะฐัะฐะตั ัััะปะบั ะฝะฐ ัะฐะนะป
4. **ะัะต ะพััะฐะปัะฝะพะต** โ ะฟะตัะตะดะฐะตััั **Planner**-ะฐะณะตะฝัั ะดะปั ะฐะฝะฐะปะธะทะฐ

**Planner** ะฟัะธะฝะธะผะฐะตั ัะตัะตะฝะธะต ะธ ะฒะพะทะฒัะฐัะฐะตั ััััะบัััะธัะพะฒะฐะฝะฝัะน ะพัะฒะตั:
- `need_clarify: true` โ ะทะฐะฟัะพั ััะพัะฝะตะฝะธั ั ะฟะพะปัะทะพะฒะฐัะตะปั
- `need_escalate: true` โ ะฟะตัะตะดะฐัะฐ ัะปะพะถะฝะพะณะพ ะฒะพะฟัะพัะฐ ัะบัะฟะตััะฝะพะน ะณััะฟะฟะต (ExpertGC)
- `draft` โ ะณะพัะพะฒัะน ะพัะฒะตั ะพั ะฟะปะฐะฝะธัะพะฒัะธะบะฐ

### ะะธะฐะปะพะณ-ะผะตะฝะตะดะถะตั

1. ะะทะฒะปะตะบะฐะตั ัะตะบััะธะต slots (product/task/โฆ).
2. o3-mini ะบะปะฐััะธัะธัะธััะตั intent โ {file | kb_search | request | small_talk} + confidence.
3. DM-Critic (4.1-mini) ะฟะพะดัะฒะตัะถะดะฐะตั. ะัะปะธ <0.5 โ intent=unknown.
4. unknown / small_talk โ follow-up ะธะปะธ courtesy.
5. file โ File-Search; **kb_search/request** โ **KB-Search-Agent** โ Planner.

### KB-Search-Agent

**ะะพะฒัะน ะฐะณะตะฝั** ะดะปั ะธะฝัะตะปะปะตะบััะฐะปัะฝะพะณะพ ะฟะพะธัะบะฐ ะฟะพ ะฑะฐะทะต ะทะฝะฐะฝะธะน ะธ ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธั ะณะพัะพะฒัั ะพัะฒะตัะพะฒ:

1. **ะัะพะฒะตััะตั ะบะพะปะปะตะบัะธั `dialogs`**:
   - **โฅ0.95** โ ะพัะฒะตั ะธะท ะฟะฐะผััะธ (reuse).
   - **0.60โ0.95** โ ะดะพะฑะฐะฒะปัะตั `similar_dialogs` ะฒ context.
   - **<0.60** โ ะธะณะฝะพัะธััะตั ะบะฐะบ ะฝะตัะตะปะตะฒะฐะฝัะฝัะต.

2. **ะะฐะฑะธัะฐะตั ััะฐะณะผะตะฝัั `docs` (RAG)**:
   - ะะพะธัะบ ะฟะพ ะดะพะบัะผะตะฝัะฐัะธะธ ั ะดะธะฝะฐะผะธัะตัะบะธะผ `k`.
   - ะะพะฑะฐะฒะปัะตั ัะตะทัะปััะฐัั ะฒ `context.rag`.

3. **ะะพะทะฒัะฐัะฐะตั (status, context) Dialog-Manager'ั**:
   - `("reuse", answer)` โ ะณะพัะพะฒัะน ะพัะฒะตั ะฟะพะปัะทะพะฒะฐัะตะปั.
   - `("escalate", context)` โ ะฟะตัะตะดะฐัะฐ Planner'ั ั ะพะฑะพะณะฐัะตะฝะฝัะผ ะบะพะฝัะตะบััะพะผ.

**ะะธะฝะฐะผะธัะตัะบะธะน k**: `k = max(3, min(10, expected_tokens // 400))` โ ะฐะดะฐะฟัะธะฒะฝะพะต ะบะพะปะธัะตััะฒะพ ัะตะทัะปััะฐัะพะฒ ะฟะพะธัะบะฐ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะพะถะธะดะฐะตะผะพะน ะดะปะธะฝั ะพัะฒะตัะฐ.

### Expert-GC: ะะพะผะตะฝะฝัะต ัะบัะฟะตััั ะธ ะะณัะตะณะฐัะพั

**ะญะบัะฟะตััะฝะฐั ะณััะฟะฟะฐ** ะฟะพะปััะฐะตั ะฟะปะฐะฝ ะพั Planner'ะฐ ะธ ััััะบัััะธัะพะฒะฐะฝะฝะพ ะตะณะพ ะฒัะฟะพะปะฝัะตั. ะััะธัะตะบัััะฐ ะฑัะปะฐ ะพะฑะฝะพะฒะปะตะฝะฐ ะดะปั ะฟะพะฒััะตะฝะธั ะบะฐัะตััะฒะฐ ะธ ะฝะฐะดะตะถะฝะพััะธ ะพัะฒะตัะพะฒ.

- **ะะธะฝะฐะผะธัะตัะบะธะน ะฒัะฑะพั ัะบัะฟะตััะฐ**: ะะฐ ะพัะฝะพะฒะต ัะปะพัะฐ `product` ะธะท ะดะธะฐะปะพะณะฐ, ัะธััะตะผะฐ ะฒัะฑะธัะฐะตั ะพะดะฝะพะณะพ ะธะท ะดะฒัั ัะบัะฟะตััะพะฒ:
    - **`Product_Expert`**: ะกะฟะตัะธะฐะปะธะทะธัะพะฒะฐะฝะฝัะน ะฐะณะตะฝั, ะบะพัะพััะน "ะทะฐัะพัะตะฝ" ะฝะฐ ะบะพะฝะบัะตัะฝัะน ะฟัะพะดัะบั (ะฝะฐะฟัะธะผะตั, "IB-v2_Expert"). ะะณะพ ัะธััะตะผะฝัะน ะฟัะพะผะฟั ัะพะดะตัะถะธั ัะบะฐะทะฐะฝะธะต ัะพะบััะธัะพะฒะฐัััั ะฝะฐ ััะพะผ ะฟัะพะดัะบัะต.
    - **`General_Expert`**: ะะณะตะฝั ะดะปั ะพะฑัะธั ะฒะพะฟัะพัะพะฒ, ะตัะปะธ ะฟัะพะดัะบั ะฝะต ัะบะฐะทะฐะฝ.
- **ะกะพััะฐะฒ ะณััะฟะฟั**:
    1. **ะะพะผะตะฝะฝัะน ัะบัะฟะตัั** (Product ะธะปะธ General) - ะฒะตะดััะธะน ะฐะณะตะฝั.
    2. **Search** - ะฐะณะตะฝั ั ะธะฝััััะผะตะฝัะพะผ `local_search` ะดะปั ะฟะพะธัะบะฐ ะฟะพ ะฑะฐะทะต ะทะฝะฐะฝะธะน.
    3. **Critic** - ะฐะณะตะฝั, ะพัะตะฝะธะฒะฐััะธะน ัะตะปะตะฒะฐะฝัะฝะพััั ะธ ะฟะพะปะฝะพัั ะฝะฐะนะดะตะฝะฝะพะน ะธะฝัะพัะผะฐัะธะธ.
    4. **EvidenceAggregator** - ัะธะฝะฐะปัะฝัะน ะฐะณะตะฝั, ะบะพัะพััะน ัะพะฑะธัะฐะตั ะฒัะต ะดะพะบะฐะทะฐัะตะปัััะฒะฐ, ัะธะฝัะตะทะธััะตั ะธะท ะฝะธั ะตะดะธะฝัะน, ััััะบัััะธัะพะฒะฐะฝะฝัะน ะพัะฒะตั ะธ ะพะฑัะทะฐัะตะปัะฝะพ ะดะพะฑะฐะฒะปัะตั ะฑะปะพะบ ั ัะธัะฐัะฐะผะธ.
- **ะะพััะดะพะบ ัะฐะฑะพัั**:
    1. ะญะบัะฟะตัั ะธะฝะธัะธะธััะตั ะพะฑััะถะดะตะฝะธะต.
    2. Search ะธ Critic ะฟัะตะดะพััะฐะฒะปััั ะธ ะพัะตะฝะธะฒะฐัั ะธะฝัะพัะผะฐัะธั.
    3. Aggregator ะธะผะตะตั ะฟะพัะปะตะดะฝะตะต ัะปะพะฒะพ, ััะพะฑั ะณะฐัะฐะฝัะธัะพะฒะฐัั, ััะพ ะพัะฒะตั ะพัะฝะพะฒะฐะฝ ะฝะฐ ัะฐะบัะฐั ะธ ัะพะดะตัะถะธั ัััะปะบะธ ะฝะฐ ะธััะพัะฝะธะบะธ.
- **ะะฝััััะผะตะฝัั**: `local_search` ะดะปั ะฟะพะธัะบะฐ ะฟะพ ะดะพะบัะผะตะฝัะฐัะธะธ ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผะธ ัะธัะฐัะฐะผะธ.

### ะะฝััััะผะตะฝั `web_search`
* ะัะธะฝััะพะฝะฝัะน ะฒัะทะพะฒ OpenAI Browser-tool.
* ะขะฐะนะผะฐัั ะทะฐะดะฐัััั `WEB_SEARCH_TIMEOUT_SEC` (ะฟะพ ัะผะพะปัะฐะฝะธั 20 ั).
* ะัะธ ััะฐะฑะฐััะฒะฐะฝะธะธ ัะฐะนะผะฐััะฐ Search-ะฐะณะตะฝั ะฒะพะทะฒัะฐัะฐะตั ัััะพะบั **TIMEOUT**,
  Critic ัะฝะธะถะฐะตั ัะฒะตัะตะฝะฝะพััั โ Expert-GC ะฟะตัะตัะพะดะธั ะบ fallback-ัะธะบะปั.

### UX Flow

ะะตัะฒะพะต ะฟัะธะฒะตัััะฒะธะต (ยซะะดัะฐะฒััะฒัะนัะต! ...ยป) ะณะตะฝะตัะธััะตััั ะฝะฐ ััะพะฝัะต
ะฟัะธ ะทะฐะณััะทะบะต ัััะฐะฝะธัั. ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะดะตะนััะฒะธัะตะปัะฝะพ ะฟะธัะตั
ยซะัะธะฒะตัยป โ ะฑัะบะตะฝะด ะพัะฒะตัะฐะตั ะบะพัะพัะบะธะผ ะฟัะธะฒะตัััะฒะธะตะผ ะฒัะพัะพะน ัะฐะท.

## Frontend Dev

```bash
cd frontend
npm i         # ะฟะตัะฒัะน ัะฐะท
npm run dev   # http://localhost:5173
```

ะคัะพะฝัะตะฝะด ะธัะฟะพะปัะทัะตั:
- React + TypeScript
- Tailwind CSS ะดะปั ััะธะปะธะทะฐัะธะธ
- WebSocket ะดะปั real-time ะพะฑัะตะฝะธั ั ะฑัะบะตะฝะดะพะผ
- ะะพะปะธ ัะพะพะฑัะตะฝะธะน: `user`, `assistant`, `assistant(f/u)` ะดะปั follow-up ะพัะฒะตัะพะฒ

### ะขะฐะนะผะฐััั
| Env                | default | ะงัะพ ะพะณัะฐะฝะธัะธะฒะฐะตั |
|--------------------|---------|------------------|
| GC_TIMEOUT_SEC     | 300     | Expert-GC (AutoGen) |
| WEB_SEARCH_TIMEOUT_SEC | 20  | web-browser search-tool |

ะัะธ ะฟัะตะฒััะตะฝะธะธ ัะฐะนะผะฐััะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะปััะฐะตั ัะธััะตะผะฝะพะต
ัะพะพะฑัะตะฝะธะต ยซโ๏ธ ะัะตะผั ะฒััะปะพโฆยป.  ะะฝะฐัะตะฝะธั ะผะพะถะฝะพ ะธะทะผะตะฝะธัั
ะฟะตัะตะผะตะฝะฝัะผะธ ััะตะดั (docker-compose, Helm values).

## ะัะปะฐะดะบะฐ Planner

ะัะปะธ ะฟะปะฐะฝะธัะพะฒัะธะบ ะฒะพะทะฒัะฐัะฐะตั ะฝะตะบะพััะตะบัะฝัะน JSON, ัะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะปะพะณะธััะตั ััััะต ะพัะฒะตัั ะผะพะดะตะปะธ ะดะปั ะฐะฝะฐะปะธะทะฐ:

```bash
# ะะพะดะบะปััะฐัััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั SQLite
sqlite3 /data/chatlog.db

# ะัะพัะผะพัั ะฟะพัะปะตะดะฝะธั ััััั ะพัะฒะตัะพะฒ ะผะพะดะตะปะธ
select content from chatlog where role='raw' order by id desc limit 5;

# ะะพะธัะบ ะพัะธะฑะพะบ JSON ะฟะพ ะฒัะตะผะตะฝะธ
select ts, content from chatlog where role='raw' and ts > datetime('now', '-1 hour');

# ะะฝะฐะปะธะท ะฒัะตั ััััั ะพัะฒะตัะพะฒ ะดะปั ะบะพะฝะบัะตัะฝะพะณะพ ะฟะพัะพะบะฐ
select turn_index, content from chatlog where thread_id='your-thread-id' and role='raw';
```

**ะะพะทะผะพะถะฝัะต ะฟัะพะฑะปะตะผั:**
- ะะพะดะตะปั ะฒะพะทะฒัะฐัะฐะตั JSON ั ะบะพะผะผะตะฝัะฐัะธัะผะธ ะธะปะธ ะดะพะฟะพะปะฝะธัะตะปัะฝัะผ ัะตะบััะพะผ
- ะะตัะบัะฐะฝะธัะพะฒะฐะฝะฝัะต ะบะฐะฒััะบะธ ะฒ ัััะพะบะพะฒัั ะฟะพะปัั
- ะะธัะฝะธะต ะทะฐะฟัััะต ะฒ ะบะพะฝัะต ะพะฑัะตะบัะพะฒ
- ะัะฒะตั ะฝะต ะฒ ัะพัะผะฐัะต JSON

**ะะตัะตะฝะธะต:** ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟััะฐะตััั ะธะทะฒะปะตัั JSON ะธะท ัะตะบััะฐ, ะฝะพ ะตัะปะธ ััะพ ะฝะตะฒะพะทะผะพะถะฝะพ, ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะปััะธั ัะพะพะฑัะตะฝะธะต "๐ค ะะพะบะฐ ะฝะต ะฟะพะฝัะป ัะพัะผัะปะธัะพะฒะบั, ััะพัะฝะธัะต ะฟะพะถะฐะปัะนััะฐ."