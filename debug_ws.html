<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .error { background: #ffeeee; color: red; }
        .success { background: #eeffee; color: green; }
        .info { background: #eeeeff; color: blue; }
        input, button { padding: 10px; margin: 5px; }
        input { width: 300px; }
    </style>
</head>
<body>
    <h1>WebSocket –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
    <div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    
    <h3>–õ–æ–≥–∏:</h3>
    <div id="logs"></div>

    <script>
        let ws = null;
        let messageCounter = 0;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateStatus(text, color = 'black') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = text;
            statusDiv.style.color = color;
        }

        function connect() {
            log("üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ws://localhost:8000/ws", 'info');
            
            try {
                ws = new WebSocket('ws://localhost:8000/ws');
                
                ws.onopen = function(event) {
                    log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!", 'success');
                    updateStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω", 'green');
                    log(`ReadyState: ${ws.readyState} (OPEN)`, 'info');
                };

                ws.onclose = function(event) {
                    log(`‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç. –ö–æ–¥: ${event.code}, –ü—Ä–∏—á–∏–Ω–∞: "${event.reason}"`, 'error');
                    updateStatus("–û—Ç–∫–ª—é—á–µ–Ω", 'red');
                    log("üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...", 'info');
                    setTimeout(connect, 3000);
                };

                ws.onerror = function(error) {
                    log(`üî• –û—à–∏–±–∫–∞ WebSocket: ${error.message || error}`, 'error');
                    updateStatus("–û—à–∏–±–∫–∞", 'red');
                };

                ws.onmessage = function(event) {
                    messageCounter++;
                    log(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ #${messageCounter}: ${event.data}`, 'success');
                    
                    try {
                        const data = JSON.parse(event.data);
                        log(`üìã Parsed JSON: ${JSON.stringify(data, null, 2)}`, 'info');
                    } catch (e) {
                        log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: ${e.message}`, 'error');
                    }
                };
                
            } catch (error) {
                log(`üí• –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WebSocket: ${error.message}`, 'error');
                updateStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è", 'red');
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                log("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ", 'error');
                return;
            }
            
            if (!ws) {
                log("‚ùå WebSocket –Ω–µ —Å–æ–∑–¥–∞–Ω", 'error');
                return;
            }
            
            log(`üîç –°–æ—Å—Ç–æ—è–Ω–∏–µ WebSocket: ${ws.readyState} (${getReadyStateText(ws.readyState)})`, 'info');
            
            if (ws.readyState !== WebSocket.OPEN) {
                log("‚ùå WebSocket –Ω–µ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏", 'error');
                return;
            }
            
            try {
                ws.send(message);
                log(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: "${message}"`, 'success');
                input.value = '';
            } catch (error) {
                log(`üí• –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, 'error');
            }
        }

        function getReadyStateText(state) {
            switch(state) {
                case WebSocket.CONNECTING: return 'CONNECTING';
                case WebSocket.OPEN: return 'OPEN';
                case WebSocket.CLOSING: return 'CLOSING';
                case WebSocket.CLOSED: return 'CLOSED';
                default: return 'UNKNOWN';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏", 'info');
        connect();
    </script>
</body>
</html>
